# STEP 2 â€” Automatic Mask Refinement Report

## Overview
This report documents the refinement of noisy SAM-2 pseudo-label masks into clean, training-ready binary masks for mangrove segmentation.

---

## Task Description

- **Objective:** Clean and refine raw masks generated by SAM-2 to produce high-quality ground truth labels for model training.
- **Script Used:** `src/labeling/mask_refinement.py`
- **Input Directories:**
  - `data/tiles_clean/` (GeoTIFF tiles)
  - `data/masks_raw/` (SAM-2 pseudo-label masks)
- **Output Directory:**  
  - `data/masks_refined/` (refined binary masks)

---

## Refinement Steps

1. Remove masks that are almost empty or almost full
2. Remove small isolated components (tiny blobs/noise)
3. Morphological operations (open + close to fill holes and smooth edges)
4. Vegetation filter: NDVI filter (using NIR and Red bands) and Green filter (for RGB imagery)
5. Fill holes in mask regions

---

## Execution Details

- The script was run with the following command:
  ```bash
  python src/labeling/mask_refinement.py \
    --tiles data/tiles_clean \
    --masks data/masks_raw \
    --out data/masks_refined \
    --min-area 500 \
    --green-ratio 1.1 \
    --use-ndvi \
    --nir-index 3 \
    --red-index 2 \
    --ndvi-th 0.25
  ```
- All masks were paired with their corresponding tiles and processed in batch mode.
- NDVI filtering was enabled (NIR band: 3, Red band: 2, NDVI threshold: 0.25).

---

## Results

- **Total masks processed:** 5,217
- **Masks successfully refined and saved:** 2,851
- **Masks skipped (bad mask):** 2,366
- **Masks skipped (no matching tile):** 0
- **Masks failed:** 0

Example output files:
- `data/masks_refined/STL_Langkawi_Mangrove10_10.png`
- `data/masks_refined/STL_Langkawi_Mangrove10_100.png`
- ... (see `data/masks_refined/` for full list)

---

## Conclusion

The automatic mask refinement step successfully converted noisy SAM-2 masks into 2,851 high-quality, training-ready binary masks. These refined masks will be used as ground truth labels for U-Net++ model training in the next step.

---

*Report generated on: <!-- add date here -->*